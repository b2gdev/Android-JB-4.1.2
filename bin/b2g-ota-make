#!/bin/sh
. "$(dirname "${0}")/b2g-prologue.sh"
includeShellDefinitions b2g-build

readonly defaultArchiveName="OTA"
readonly defaultHeapSize="1500M"

showHelp() {
cat <<END_HELP
usage: ${scriptName} [option ...]
-h       Show this usage summary on standard output, and then exit.
-m size  Specify the Java memory size (defaults to ${defaultHeapSize}).
-n name  Specify the archive name (defaults to ${defaultArchiveName}).
-s       Invoke an interactive shell to inspect/modify the archive.
END_HELP
}

makeDirectory() {
  local directory="${1}"

  mkdir -p "${directory}"
}

getFile() {
  local file="${1}"

  [ "${file}" = "${file#/}" ] && file="${buildDirectory}/${file}"
  cp "${file}" .
}

getExecutable() {
  local program="${1}"

  getFile "tcbin_misc/executables/${program}"
  chmod a+rx "${program}"
}

archiveName=""
heapSize=""
interactiveShell=false

handleOption_m() {
  heapSize="${OPTARG}"
}

handleOption_n() {
  archiveName="${OPTARG}"
}

handleOption_s() {
  interactiveShell=true
}

handleArguments "hm:n:s" "${@}"
[ -n "${heapSize}" ] || heapSize="${defaultHeapSize}"

[ -n "${archiveName}" ] || archiveName="${defaultArchiveName}"
[ "${archiveName}" = "${archiveName#/}" ] && archiveName="${initialDirectory}/${archiveName}"
[ "${archiveName}" = "${archiveName%/}" ] || syntaxError "invalid archive name: ${archiveName}"

readonly archiveExtension="zip"
readonly unsignedArchive="unsigned.${archiveExtension}"
readonly signedArchive="${archiveName}.${archiveExtension}"

readonly signingJar="signapk.jar"
readonly keyName="release"
readonly keyExtension="pk8"
readonly certificateExtension="x509.pem"

setBuildDirectory
needTemporaryDirectory
programMessage "collecting files"

cd "${temporaryDirectory}"
getFile "out/host/linux-x86/framework/${signingJar}"

for extension in "${keyExtension}" "${certificateExtension}"
do
  getFile "device/ti/beagleboard/security/${keyName}.${extension}"
done

updateDirectory="${temporaryDirectory}/update"
makeDirectory "${updateDirectory}"
cd "${updateDirectory}"
getFile "${bootImage}"
getFile "${androidImage}"
getFile "${recoveryImage}"
getFile "${systemImage}"
getExecutable "setup_3g_audio"

metaDirectory="${updateDirectory}/META-INF/com/google/android"
makeDirectory "${metaDirectory}"
cd "${metaDirectory}"
getFile "${scriptDirectory}/update-binary"
cat "${scriptDirectory}/"*".upd" >"updater-script"

systemDirectory="${updateDirectory}/system"
makeDirectory "${systemDirectory}"

binDirectory="${systemDirectory}/bin"
makeDirectory "${binDirectory}"
cd "${binDirectory}"
getExecutable "mount_emmc"
getExecutable "clean_emmc"

dataDirectory="${updateDirectory}/data"
makeDirectory "${dataDirectory}"

"${interactiveShell}" && {
  programMessage "invoking interactive shell"
  cd "${updateDirectory}"
  export "PS1=${programName}> "
  "${SHELL:-/bin/sh}" || :
}

programMessage "creating archive"
cd "${updateDirectory}"
zip -q -9 -r "${temporaryDirectory}/${unsignedArchive}" *

programMessage "signing archive"
cd "${temporaryDirectory}"
java "-Xmx${heapSize}" -jar "${signingJar}" -w \
     "${keyName}.${certificateExtension}" \
     "${keyName}.${keyExtension}" \
     "${unsignedArchive}" "${signedArchive}"

programMessage "done"
exit 0
