#!/bin/sh
. "$(dirname "${0}")/b2g-prologue.sh"
includeShellDefinitions b2g-partitions
includeShellDefinitions b2g-build

showHelp() {
cat <<END_HELP
usage: ${scriptName} [option ...]
-f  Format the SD card.
-h  Show this usage summary on standard output, and then exit.
END_HELP
}

formatDevice=false

handleOption_f() {
  formatDevice=true
}

handleParameters() {
  [ "${#}" -gt 0 ] || syntaxError "missing device"
  sdcardDevice="${1}"
  shift 1

  noMoreParameters "${@}"
}

handleArguments "fh" "${@}"

[ -b "${sdcardDevice}" ] || syntaxError "not a block device: ${sdcardDevice}"
[ -r "${sdcardDevice}" ] || syntaxError "device not readable: ${sdcardDevice}"
[ -w "${sdcardDevice}" ] || syntaxError "device not writable: ${sdcardDevice}"
isActiveDevice "${sdcardDevice}" && syntaxError "device in use: ${sdcardDevice}"

if "${formatDevice}"
then
  makePartitionTable "${sdcardDevice}" msdos

  addPartition "${sdcardDevice}" 6 fat16
  setPartitionProperty "${sdcardDevice}" 1 boot on
  makeFileSystem_DOS "${sdcardDevice}" 1 boot

  addPartition "${sdcardDevice}" 1000 ext4
  makeFileSystem_Linux "${sdcardDevice}" 2 rootfs

  addPartition "${sdcardDevice}" 1000 fat16
  makeFileSystem_DOS "${sdcardDevice}" 3 data

  addPartition "${sdcardDevice}"
elif ! verifyPartitions "${sdcardDevice}" e boot 83 rootfs e data
then
  semanticError "not formatted correctly: ${sdcardDevice}"
fi

setBuildDirectory
needTemporaryDirectory

exit 0
